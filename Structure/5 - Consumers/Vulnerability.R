require(readxl)
require(plotly)
require(dygraphs)
require(png)
require("DT")
###### UI Function ######

source("Structure/Global.R")

VulnerabilityOutput <- function(id) {
  ns <- NS(id)
  tagList(
    tabsetPanel(
      tabPanel("Debt Repayments",
    fluidRow(column(8,
                    h3("Proportion of customers repaying a debt", style = "color: #68c3ea;  font-weight:bold"),
                    h4(textOutput(ns('DebtRepaymentSubtitle')), style = "color: #68c3ea;")
    ),
             column(
               4, style = 'padding:15px;',
               downloadButton(ns('DebtRepayment.png'), 'Download Graph', style="float:right")
             )),
    
    tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;"),
    #dygraphOutput(ns("DebtRepaymentPlot")),
    plotlyOutput(ns("DebtRepaymentPlot"), height = "500px")%>% withSpinner(color="#68c3ea"),
    tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;")),
    tabPanel("Arrears only",
      fluidRow(column(8,
                      h3("Proportion of customers in arrears and not yet on repayment arrangement", style = "color: #68c3ea;  font-weight:bold"),
                      h4(textOutput(ns('ArrearsOnlySubtitle')), style = "color: #68c3ea;")
      ),
      column(
        4, style = 'padding:15px;',
        downloadButton(ns('ArrearsOnly.png'), 'Download Graph', style="float:right")
      )),
      
      tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;"),
      #dygraphOutput(ns("ArrearsOnlyPlot")),
      plotlyOutput(ns("ArrearsOnlyPlot"), height = "500px")%>% withSpinner(color="#68c3ea"),
      tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;")),
    tabPanel("Repayment Arrangement",
             fluidRow(column(8,
                             h3("Proportion of customers in arrears and not yet on repayment arrangement", style = "color: #68c3ea;  font-weight:bold"),
                             h4(textOutput(ns('RepaymentArrangementSubtitle')), style = "color: #68c3ea;")
             ),
             column(
               4, style = 'padding:15px;',
               downloadButton(ns('RepaymentArrangement.png'), 'Download Graph', style="float:right")
             )),
             
             tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;"),
             #dygraphOutput(ns("RepaymentArrangementPlot")),
             plotlyOutput(ns("RepaymentArrangementPlot"), height = "500px")%>% withSpinner(color="#68c3ea"),
             tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;")),
    tabPanel("Priority Services Register",
             fluidRow(column(8,
                             h3("Proportion of customers on the Priority Services Register (PSR)", style = "color: #68c3ea;  font-weight:bold"),
                             h4(textOutput(ns('PriorityServicesRegisterSubtitle')), style = "color: #68c3ea;")
             ),
             column(
               4, style = 'padding:15px;',
               downloadButton(ns('PriorityServicesRegister.png'), 'Download Graph', style="float:right")
             )),
             
             tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;"),
             #dygraphOutput(ns("PriorityServicesRegisterPlot")),
             plotlyOutput(ns("PriorityServicesRegisterPlot"), height = "500px")%>% withSpinner(color="#68c3ea"),
             tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;"))
    ),
    fluidRow(
    column(10,h3("Commentary", style = "color: #68c3ea;  font-weight:bold")),
    column(2,style = "padding:15px",actionButton(ns("ToggleText"), "Show/Hide Text", style = "float:right; "))),
    
    fluidRow(
    uiOutput(ns("Text"))
    ),
    tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;"),
    tabsetPanel(
      tabPanel("Debt Repayments",
    fluidRow(
    column(10, h3("Data - Proportion of customers repaying a debt", style = "color: #68c3ea;  font-weight:bold")),
    column(2, style = "padding:15px",  actionButton(ns("ToggleTable1"), "Show/Hide Table", style = "float:right; "))
    ),
    fluidRow(
      column(12, dataTableOutput(ns("DebtRepaymentTable"))%>% withSpinner(color="#68c3ea"))),
    tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;")),
    tabPanel("Arrears Only",
             fluidRow(
               column(10, h3("Data - Proportion of customers repaying a debt", style = "color: #68c3ea;  font-weight:bold")),
               column(2, style = "padding:15px",  actionButton(ns("ToggleTable2"), "Show/Hide Table", style = "float:right; "))
             ),
             fluidRow(
               column(12, dataTableOutput(ns("ArrearsOnlyTable"))%>% withSpinner(color="#68c3ea"))),
             tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;")),
    tabPanel("Repayment Arrangement",
             fluidRow(
               column(10, h3("Data - Proportion of customers repaying a debt", style = "color: #68c3ea;  font-weight:bold")),
               column(2, style = "padding:15px",  actionButton(ns("ToggleTable3"), "Show/Hide Table", style = "float:right; "))
             ),
             fluidRow(
               column(12, dataTableOutput(ns("RepaymentArrangementTable"))%>% withSpinner(color="#68c3ea"))),
             tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;")),
    tabPanel("Priority Services Register",
             fluidRow(
               column(10, h3("Data - Proportion of customers on the Priority Services Register (PSR)", style = "color: #68c3ea;  font-weight:bold")),
               column(2, style = "padding:15px",  actionButton(ns("ToggleTable3"), "Show/Hide Table", style = "float:right; "))
             ),
             fluidRow(
               column(12, dataTableOutput(ns("PriorityServicesRegisterTable"))%>% withSpinner(color="#68c3ea"))),
             tags$hr(style = "height:3px;border:none;color:#68c3ea;background-color:#68c3ea;"))
    ),
    fluidRow(
      column(1,
             p("Next update:")),
      column(2,
             DateLookup(c("OfgemVulnerability"))),
      column(1, align = "right",
             p("Sources:")),
      column(
        8,
        align = "right",
        SourceLookup("OfgemVulnerability")
        
      )
    )
  )
}




###### Server ######
Vulnerability <- function(input, output, session) {

  
  
  if (exists("PackageHeader") == 0) {
    source("Structure/PackageHeader.R")
  }
  
  print("Vulnerability.R")
  ###### Renewable Energy ###### ######


  ChartColours <- c("#4292c6", "#7bccc4", "#08519c", "#ef3b2c")
  
  DebtRepayment <- read_csv("Processed Data/Output/Consumers/DebtRepayment.csv")
  
  ArrearsOnly <- read_csv("Processed Data/Output/Consumers/ArrearsOnly.csv")
  
  RepaymentArrangement <- read_csv("Processed Data/Output/Consumers/RepaymentArrangement.csv")
  RepaymentArrangement <- RepaymentArrangement[complete.cases(RepaymentArrangement),]
  
  PriorityServicesRegister <- read_csv("Processed Data/Output/Consumers/PriorityServicesRegister.csv")
  PriorityServicesRegister <- PriorityServicesRegister[complete.cases(PriorityServicesRegister),]
  
  ### From ESD ###
  
  output$DebtRepaymentSubtitle <- renderText({
    
    paste("Scotland,", min(DebtRepayment$Year),"-",max(DebtRepayment$Year))
    
  })
  
  output$DebtRepaymentPlot <- renderPlotly({
    
   
    
    p <-  plot_ly(DebtRepayment,x = ~ Year ) %>% 
      add_trace(data = DebtRepayment,
                x = ~ Year,
                y = ~ ElecScotland,
                name = "Electricity",
                type = 'scatter',
                mode = 'lines',
                legendgroup = "1",
                text = paste0(
                  "Electricity: ",
                  percent(DebtRepayment$ElecScotland, .1),
                  "\nYear: ",
                  DebtRepayment$Year
                ),
                hoverinfo = 'text',
                line = list(width = 6, color = ChartColours[1], dash = "none")
      ) %>% 
      add_trace(
        data = tail(DebtRepayment[which(DebtRepayment$ElecScotland > 0 | DebtRepayment$ElecScotland < 0),], 1),
        x = ~ Year,
        y = ~ ElecScotland,
        legendgroup = "1",
        name = "Electricity",
        text = paste0(
          "Electricity: ",
          percent(DebtRepayment[which(DebtRepayment$ElecScotland > 0 | DebtRepayment$ElecScotland < 0),][-1,]$ElecScotland, .1),
          "\nYear: ",
          DebtRepayment[which(DebtRepayment$ElecScotland > 0 | DebtRepayment$ElecScotland < 0),][-1,]$Year
        ),
        hoverinfo = 'text',
        showlegend = FALSE ,
        type = "scatter",
        mode = 'markers',
        marker = list(size = 18, 
                      color = ChartColours[1])
      ) %>% 
      add_trace(data = DebtRepayment,
                x = ~ Year,
                y = ~ GasScotland,
                name = "Gas",
                type = 'scatter',
                mode = 'lines',
                legendgroup = "2",
                text = paste0(
                  "Gas: ",
                  percent(DebtRepayment$GasScotland, .1),
                  "\nYear: ",
                  DebtRepayment$Year
                ),
                hoverinfo = 'text',
                line = list(width = 6, color = ChartColours[2], dash = "none")
      ) %>% 
      add_trace(
        data = tail(DebtRepayment[which(DebtRepayment$GasScotland > 0 | DebtRepayment$GasScotland < 0),], 1),
        x = ~ Year,
        y = ~ GasScotland,
        legendgroup = "2",
        name = "Gas",
        text = paste0(
          "Gas: ",
          percent(DebtRepayment[which(DebtRepayment$GasScotland > 0 | DebtRepayment$GasScotland < 0),][-1,]$GasScotland, .1),
          "\nYear: ",
          DebtRepayment[which(DebtRepayment$GasScotland > 0 | DebtRepayment$GasScotland < 0),][-1,]$Year
        ),
        hoverinfo = 'text',
        showlegend = FALSE ,
        type = "scatter",
        mode = 'markers',
        marker = list(size = 18, 
                      color = ChartColours[2])
      ) %>% 
      layout(
        barmode = 'stack',
        bargap = 0.66,
        legend = list(font = list(color = "#126992"),
                      orientation = 'h'),
        hoverlabel = list(font = list(color = "white"),
                          hovername = 'text'),
        hovername = 'text',
        
        xaxis = list(title = "",
                     showgrid = FALSE),
        yaxis = list(
          title = "",
          tickformat = "%",
          showgrid = TRUE,
          zeroline = TRUE,
          zerolinecolor = ChartColours[1],
          zerolinewidth = 2,
          rangemode = "tozero"
        )
      ) %>% 
      config(displayModeBar = F)
    p
    
  })
  
  
  output$DebtRepaymentTable = renderDataTable({
    
    DebtRepaymentTable <- DebtRepayment
    
    names(DebtRepaymentTable) <- c("Year", "Electricity - England", "Electricity", "Electricity - Wales", "Gas - England", "Gas", "Gas - Wales")
    
    datatable(
      DebtRepaymentTable[c(1,3,6)],
      extensions = 'Buttons',
      
      rownames = FALSE,
      options = list(
        paging = TRUE,
        pageLength = -1,
        searching = TRUE,
        fixedColumns = FALSE,
        autoWidth = TRUE,
        ordering = TRUE,
        title = "Proportion of customers repaying a debt",
        dom = 'ltBp',
        buttons = list(
          list(extend = 'copy'),
          list(
            extend = 'excel',
            title = 'Proportion of customers repaying a debt',
            header = TRUE
          ),
          list(extend = 'csv',
               title = 'Proportion of customers repaying a debt')
        ),
        
        # customize the length menu
        lengthMenu = list( c(10, 20, -1) # declare values
                           , c(10, 20, "All") # declare titles
        ), # end of lengthMenu customization
        pageLength = 10
      )
    ) %>%
      formatPercentage(c(2:3), 1)
  })
  
  
  output$DebtRepayment.png <- downloadHandler(
    filename = "DebtRepayment.png",
    content = function(file) {
      
      sourcecaption = "Source: Ofgem"
      plottitle = "Proportion of customers repaying a debt"
      
      width <- max(DebtRepayment$Year) - min(DebtRepayment$Year)
      
      #DebtRepayment$ElecScotlandPercentage <- PercentLabel(DebtRepayment$ElecScotland)
      
      
      DebtRepaymentChart <- DebtRepayment %>%
        ggplot(aes(x = Year), family = "Century Gothic") +
        
        geom_line(
          aes(
            y = ElecScotland,
            colour = ChartColours[2],
            label = percent(ElecScotland)
          ),
          size = 1.5,
          family = "Century Gothic"
        ) +
        geom_text(
          aes(
            x = Year - (width*0.05),
            y = ElecScotland,
            label = ifelse(Year == min(Year), percent(ElecScotland, 0.1), ""),
            hjust = 0.5,
            colour = ChartColours[2],
            fontface = 2
          ),
          family = "Century Gothic"
        ) +
        geom_text(
          aes(
            x = Year + (width*0.065),
            y = ElecScotland,
            label = ifelse(Year == max(Year), percent(ElecScotland, 0.1), ""),
            hjust = 0.5,
            vjust = 1,
            colour = ChartColours[2],
            fontface = 2
          ),
          family = "Century Gothic"
        ) +
        geom_point(
          data = tail(DebtRepayment, 1),
          aes(
            x = Year,
            y = ElecScotland,
            colour = ChartColours[2],
            show_guide = FALSE
          ),
          size = 4,
          family = "Century Gothic"
        ) +
        geom_text(
          aes(
            x = mean(Year),
            y = mean(ElecScotland),
            label = "Electricity",
            hjust = 0.5,
            vjust = 2,
            colour = ChartColours[2],
            fontface = 2
          ),
          family = "Century Gothic"
        ) +
        geom_line(
          aes(
            y = `GasScotland`,
            colour = ChartColours[3],
            label = paste0(`GasScotland` * 100, "%")
          ),
          size = 1.5,
          family = "Century Gothic"
        ) +
        geom_text(
          aes(
            x = Year - (width*0.05),
            y = `GasScotland`,
            label = ifelse(Year == min(Year), percent(GasScotland, 0.1), ""),
            hjust = 0.5,
            colour = ChartColours[3],
            fontface = 2
          ),
          family = "Century Gothic"
        ) +
        geom_text(
          aes(
            x = Year + (width*0.065),
            y = `GasScotland`,
            label = ifelse(Year == max(Year), percent(GasScotland, 0.1), ""),
            hjust = 0.5,
            vjust = 0,
            colour = ChartColours[3],
            fontface = 2
          ),
          family = "Century Gothic"
        ) +
        geom_point(
          data = tail(DebtRepayment, 1),
          aes(
            x = Year,
            y = `GasScotland`,
            colour = ChartColours[3],
            show_guide = FALSE
          ),
          size = 4,
          family = "Century Gothic"
        ) +
        geom_text(
          aes(
            x = mean(Year),
            y = mean(`GasScotland`),
            label = "Gas",
            hjust = 0.5,
            vjust = -4,
            colour = ChartColours[3],
            fontface = 2
          ),
          family = "Century Gothic"
        ) +
        geom_text(
          aes(
            x = Year,
            y = 0,
            label = ifelse(Year == max(Year) |
                             Year == min(Year), Year, ""),
            hjust = 0.5,
            vjust = 1.5,
            fontface = 2
          ),
          colour = ChartColours[1],
          family = "Century Gothic"
        )
      
      
      DebtRepaymentChart <-
        LinePercentChart(DebtRepaymentChart,
                         DebtRepayment,
                         plottitle,
                         sourcecaption,
                         ChartColours)
      
      DebtRepaymentChart <- DebtRepaymentChart +
        xlim(min(DebtRepayment$Year) - (width*0.1) , max(DebtRepayment$Year) + (width*0.1))
      
      DebtRepaymentChart
      
      ggsave(
        file,
        plot =  DebtRepaymentChart,
        width = 14,
        height = 14,
        units = "cm",
        dpi = 300
      )
      
    }
  )
  
    observeEvent(input$ToggleTable1, {
    toggle("DebtRepaymentTable")
  })
    
    
    
    output$ArrearsOnlySubtitle <- renderText({
      
      paste("Scotland,", min(ArrearsOnly$Year),"-",max(ArrearsOnly$Year))
      
    })
    
    output$ArrearsOnlyPlot <- renderPlotly({
      
      
      
      p <-  plot_ly(ArrearsOnly,x = ~ Year ) %>% 
        add_trace(data = ArrearsOnly,
                  x = ~ Year,
                  y = ~ ElecScotland,
                  name = "Electricity",
                  type = 'scatter',
                  mode = 'lines',
                  legendgroup = "1",
                  text = paste0(
                    "Electricity: ",
                    percent(ArrearsOnly$ElecScotland, .1),
                    "\nYear: ",
                    ArrearsOnly$Year
                  ),
                  hoverinfo = 'text',
                  line = list(width = 6, color = ChartColours[1], dash = "none")
        ) %>% 
        add_trace(
          data = tail(ArrearsOnly[which(ArrearsOnly$ElecScotland > 0 | ArrearsOnly$ElecScotland < 0),], 1),
          x = ~ Year,
          y = ~ ElecScotland,
          legendgroup = "1",
          name = "Electricity",
          text = paste0(
            "Electricity: ",
            percent(ArrearsOnly[which(ArrearsOnly$ElecScotland > 0 | ArrearsOnly$ElecScotland < 0),][-1,]$ElecScotland, .1),
            "\nYear: ",
            ArrearsOnly[which(ArrearsOnly$ElecScotland > 0 | ArrearsOnly$ElecScotland < 0),][-1,]$Year
          ),
          hoverinfo = 'text',
          showlegend = FALSE ,
          type = "scatter",
          mode = 'markers',
          marker = list(size = 18, 
                        color = ChartColours[1])
        ) %>% 
        add_trace(data = ArrearsOnly,
                  x = ~ Year,
                  y = ~ GasScotland,
                  name = "Gas",
                  type = 'scatter',
                  mode = 'lines',
                  legendgroup = "2",
                  text = paste0(
                    "Gas: ",
                    percent(ArrearsOnly$GasScotland, .1),
                    "\nYear: ",
                    ArrearsOnly$Year
                  ),
                  hoverinfo = 'text',
                  line = list(width = 6, color = ChartColours[2], dash = "none")
        ) %>% 
        add_trace(
          data = tail(ArrearsOnly[which(ArrearsOnly$GasScotland > 0 | ArrearsOnly$GasScotland < 0),], 1),
          x = ~ Year,
          y = ~ GasScotland,
          legendgroup = "2",
          name = "Gas",
          text = paste0(
            "Gas: ",
            percent(ArrearsOnly[which(ArrearsOnly$GasScotland > 0 | ArrearsOnly$GasScotland < 0),][-1,]$GasScotland, .1),
            "\nYear: ",
            ArrearsOnly[which(ArrearsOnly$GasScotland > 0 | ArrearsOnly$GasScotland < 0),][-1,]$Year
          ),
          hoverinfo = 'text',
          showlegend = FALSE ,
          type = "scatter",
          mode = 'markers',
          marker = list(size = 18, 
                        color = ChartColours[2])
        ) %>% 
        layout(
          barmode = 'stack',
          bargap = 0.66,
          legend = list(font = list(color = "#126992"),
                        orientation = 'h'),
          hoverlabel = list(font = list(color = "white"),
                            hovername = 'text'),
          hovername = 'text',
          
          xaxis = list(title = "",
                       showgrid = FALSE),
          yaxis = list(
            title = "",
            tickformat = "%",
            showgrid = TRUE,
            zeroline = TRUE,
            zerolinecolor = ChartColours[1],
            zerolinewidth = 2,
            rangemode = "tozero"
          )
        ) %>% 
        config(displayModeBar = F)
      p
      
    })
    
    
    output$ArrearsOnlyTable = renderDataTable({
      
      ArrearsOnlyTable <- ArrearsOnly
      
      names(ArrearsOnlyTable) <- c("Year", "Electricity - England", "Electricity", "Electricity - Wales", "Gas - England", "Gas", "Gas - Wales")
      
      datatable(
        ArrearsOnlyTable[c(1,3,6)],
        extensions = 'Buttons',
        
        rownames = FALSE,
        options = list(
          paging = TRUE,
          pageLength = -1,
          searching = TRUE,
          fixedColumns = FALSE,
          autoWidth = TRUE,
          ordering = TRUE,
          title = "Proportion of customers repaying a debt",
          dom = 'ltBp',
          buttons = list(
            list(extend = 'copy'),
            list(
              extend = 'excel',
              title = 'Proportion of customers repaying a debt',
              header = TRUE
            ),
            list(extend = 'csv',
                 title = 'Proportion of customers repaying a debt')
          ),
          
          # customize the length menu
          lengthMenu = list( c(10, 20, -1) # declare values
                             , c(10, 20, "All") # declare titles
          ), # end of lengthMenu customization
          pageLength = 10
        )
      ) %>%
        formatPercentage(c(2:3), 1)
    })
    
    
    output$ArrearsOnly.png <- downloadHandler(
      filename = "ArrearsOnly.png",
      content = function(file) {
        
        sourcecaption = "Source: Ofgem"
        plottitle = "Proportion of customers in arrears and\nnot yet on repayment arrangement"
        
        width <- max(ArrearsOnly$Year) - min(ArrearsOnly$Year)
        
        #ArrearsOnly$ElecScotlandPercentage <- PercentLabel(ArrearsOnly$ElecScotland)
        
        
        ArrearsOnlyChart <- ArrearsOnly %>%
          ggplot(aes(x = Year), family = "Century Gothic") +
          
          geom_line(
            aes(
              y = ElecScotland,
              colour = ChartColours[2],
              label = percent(ElecScotland)
            ),
            size = 1.5,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year - (width*0.05),
              y = ElecScotland,
              label = ifelse(Year == min(Year), percent(ElecScotland, 0.1), ""),
              hjust = 0.5,
              colour = ChartColours[2],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year + (width*0.065),
              y = ElecScotland,
              label = ifelse(Year == max(Year), percent(ElecScotland, 0.1), ""),
              hjust = 0.5,
              vjust = 0,
              colour = ChartColours[2],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_point(
            data = tail(ArrearsOnly, 1),
            aes(
              x = Year,
              y = ElecScotland,
              colour = ChartColours[2],
              show_guide = FALSE
            ),
            size = 4,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = mean(Year),
              y = mean(ElecScotland),
              label = "Electricity",
              hjust = 0.5,
              vjust = -2.5,
              colour = ChartColours[2],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_line(
            aes(
              y = `GasScotland`,
              colour = ChartColours[3],
              label = paste0(`GasScotland` * 100, "%")
            ),
            size = 1.5,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year - (width*0.05),
              y = `GasScotland`,
              label = ifelse(Year == min(Year), percent(GasScotland, 0.1), ""),
              hjust = 0.5,
              colour = ChartColours[3],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year + (width*0.065),
              y = `GasScotland`,
              label = ifelse(Year == max(Year), percent(GasScotland, 0.1), ""),
              hjust = 0.5,
              vjust = 0.6,
              colour = ChartColours[3],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_point(
            data = tail(ArrearsOnly, 1),
            aes(
              x = Year,
              y = `GasScotland`,
              colour = ChartColours[3],
              show_guide = FALSE
            ),
            size = 4,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = mean(Year),
              y = mean(`GasScotland`),
              label = "Gas",
              hjust = 0.5,
              vjust = 3,
              colour = ChartColours[3],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year,
              y = 0,
              label = ifelse(Year == max(Year) |
                               Year == min(Year), Year, ""),
              hjust = 0.5,
              vjust = 1.5,
              fontface = 2
            ),
            colour = ChartColours[1],
            family = "Century Gothic"
          )
        
        
        ArrearsOnlyChart <-
          LinePercentChart(ArrearsOnlyChart,
                           ArrearsOnly,
                           plottitle,
                           sourcecaption,
                           ChartColours)
        
        ArrearsOnlyChart <- ArrearsOnlyChart +
          xlim(min(ArrearsOnly$Year) - (width*0.1) , max(ArrearsOnly$Year) + (width*0.1))
        
        ArrearsOnlyChart
        
        ggsave(
          file,
          plot =  ArrearsOnlyChart,
          width = 14,
          height = 14,
          units = "cm",
          dpi = 300
        )
        
      }
    )
    
    observeEvent(input$ToggleTable2, {
      toggle("ArrearsOnlyTable")
    })
    
    
    
    
    
    output$RepaymentArrangementSubtitle <- renderText({
      
      paste("Scotland,", min(RepaymentArrangement$Year),"-",max(RepaymentArrangement$Year))
      
    })
    
    output$RepaymentArrangementPlot <- renderPlotly({
      
      
      
      p <-  plot_ly(RepaymentArrangement,x = ~ Year ) %>% 
        add_trace(data = RepaymentArrangement,
                  x = ~ Year,
                  y = ~ ElecScotland,
                  name = "Electricity",
                  type = 'scatter',
                  mode = 'lines',
                  legendgroup = "1",
                  text = paste0(
                    "Electricity: ",
                    percent(RepaymentArrangement$ElecScotland, .1),
                    "\nYear: ",
                    RepaymentArrangement$Year
                  ),
                  hoverinfo = 'text',
                  line = list(width = 6, color = ChartColours[1], dash = "none")
        ) %>% 
        add_trace(
          data = tail(RepaymentArrangement[which(RepaymentArrangement$ElecScotland > 0 | RepaymentArrangement$ElecScotland < 0),], 1),
          x = ~ Year,
          y = ~ ElecScotland,
          legendgroup = "1",
          name = "Electricity",
          text = paste0(
            "Electricity: ",
            percent(RepaymentArrangement[which(RepaymentArrangement$ElecScotland > 0 | RepaymentArrangement$ElecScotland < 0),][-1,]$ElecScotland, .1),
            "\nYear: ",
            RepaymentArrangement[which(RepaymentArrangement$ElecScotland > 0 | RepaymentArrangement$ElecScotland < 0),][-1,]$Year
          ),
          hoverinfo = 'text',
          showlegend = FALSE ,
          type = "scatter",
          mode = 'markers',
          marker = list(size = 18, 
                        color = ChartColours[1])
        ) %>% 
        add_trace(data = RepaymentArrangement,
                  x = ~ Year,
                  y = ~ GasScotland,
                  name = "Gas",
                  type = 'scatter',
                  mode = 'lines',
                  legendgroup = "2",
                  text = paste0(
                    "Gas: ",
                    percent(RepaymentArrangement$GasScotland, .1),
                    "\nYear: ",
                    RepaymentArrangement$Year
                  ),
                  hoverinfo = 'text',
                  line = list(width = 6, color = ChartColours[2], dash = "none")
        ) %>% 
        add_trace(
          data = tail(RepaymentArrangement[which(RepaymentArrangement$GasScotland > 0 | RepaymentArrangement$GasScotland < 0),], 1),
          x = ~ Year,
          y = ~ GasScotland,
          legendgroup = "2",
          name = "Gas",
          text = paste0(
            "Gas: ",
            percent(RepaymentArrangement[which(RepaymentArrangement$GasScotland > 0 | RepaymentArrangement$GasScotland < 0),][-1,]$GasScotland, .1),
            "\nYear: ",
            RepaymentArrangement[which(RepaymentArrangement$GasScotland > 0 | RepaymentArrangement$GasScotland < 0),][-1,]$Year
          ),
          hoverinfo = 'text',
          showlegend = FALSE ,
          type = "scatter",
          mode = 'markers',
          marker = list(size = 18, 
                        color = ChartColours[2])
        ) %>% 
        layout(
          barmode = 'stack',
          bargap = 0.66,
          legend = list(font = list(color = "#126992"),
                        orientation = 'h'),
          hoverlabel = list(font = list(color = "white"),
                            hovername = 'text'),
          hovername = 'text',
          
          xaxis = list(title = "",
                       showgrid = FALSE),
          yaxis = list(
            title = "",
            tickformat = "%",
            showgrid = TRUE,
            zeroline = TRUE,
            zerolinecolor = ChartColours[1],
            zerolinewidth = 2,
            rangemode = "tozero"
          )
        ) %>% 
        config(displayModeBar = F)
      p
      
    })
    
    
    output$RepaymentArrangementTable = renderDataTable({
      
      RepaymentArrangementTable <- RepaymentArrangement
      
      names(RepaymentArrangementTable) <- c("Year", "Electricity - England", "Electricity", "Electricity - Wales", "Gas - England", "Gas", "Gas - Wales")
      
      datatable(
        RepaymentArrangementTable[c(1,3,6)],
        extensions = 'Buttons',
        
        rownames = FALSE,
        options = list(
          paging = TRUE,
          pageLength = -1,
          searching = TRUE,
          fixedColumns = FALSE,
          autoWidth = TRUE,
          ordering = TRUE,
          title = "Proportion of customers repaying a debt",
          dom = 'ltBp',
          buttons = list(
            list(extend = 'copy'),
            list(
              extend = 'excel',
              title = 'Proportion of customers repaying a debt',
              header = TRUE
            ),
            list(extend = 'csv',
                 title = 'Proportion of customers repaying a debt')
          ),
          
          # customize the length menu
          lengthMenu = list( c(10, 20, -1) # declare values
                             , c(10, 20, "All") # declare titles
          ), # end of lengthMenu customization
          pageLength = 10
        )
      ) %>%
        formatPercentage(c(2:3), 1)
    })
    
    
    output$RepaymentArrangement.png <- downloadHandler(
      filename = "RepaymentArrangement.png",
      content = function(file) {
        
        sourcecaption = "Source: Ofgem"
        plottitle = "Proportion of customers in debt (repaying\nand in arrears) who have a repayment\narrangement set up"
        
        width <- max(RepaymentArrangement$Year) - min(RepaymentArrangement$Year)
        
        #RepaymentArrangement$ElecScotlandPercentage <- PercentLabel(RepaymentArrangement$ElecScotland)
        
        
        RepaymentArrangementChart <- RepaymentArrangement %>%
          ggplot(aes(x = Year), family = "Century Gothic") +
          
          geom_line(
            aes(
              y = ElecScotland,
              colour = ChartColours[2],
              label = percent(ElecScotland)
            ),
            size = 1.5,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year - (width*0.06),
              y = ElecScotland,
              label = ifelse(Year == min(Year), percent(ElecScotland, 0.1), ""),
              hjust = 0.5,
              colour = ChartColours[2],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year + (width*0.07),
              y = ElecScotland,
              label = ifelse(Year == max(Year), percent(ElecScotland, 0.1), ""),
              hjust = 0.5,
              vjust = 1,
              colour = ChartColours[2],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_point(
            data = tail(RepaymentArrangement, 1),
            aes(
              x = Year,
              y = ElecScotland,
              colour = ChartColours[2],
              show_guide = FALSE
            ),
            size = 4,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = mean(Year),
              y = mean(ElecScotland),
              label = "Electricity",
              hjust = 0.5,
              vjust = 3,
              colour = ChartColours[2],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_line(
            aes(
              y = `GasScotland`,
              colour = ChartColours[3],
              label = paste0(`GasScotland` * 100, "%")
            ),
            size = 1.5,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year - (width*0.06),
              y = `GasScotland`,
              label = ifelse(Year == min(Year), percent(GasScotland, 0.1), ""),
              hjust = 0.5,
              colour = ChartColours[3],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year + (width*0.07),
              y = `GasScotland`,
              label = ifelse(Year == max(Year), percent(GasScotland, 0.1), ""),
              hjust = 0.5,
              vjust = 0,
              colour = ChartColours[3],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_point(
            data = tail(RepaymentArrangement, 1),
            aes(
              x = Year,
              y = `GasScotland`,
              colour = ChartColours[3],
              show_guide = FALSE
            ),
            size = 4,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = mean(Year),
              y = mean(`GasScotland`),
              label = "Gas",
              hjust = 0.5,
              vjust = -1,
              colour = ChartColours[3],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year,
              y = 0,
              label = ifelse(Year == max(Year) |
                               Year == min(Year), Year, ""),
              hjust = 0.5,
              vjust = 1.5,
              fontface = 2
            ),
            colour = ChartColours[1],
            family = "Century Gothic"
          )
        
        
        RepaymentArrangementChart <-
          LinePercentChart(RepaymentArrangementChart,
                           RepaymentArrangement,
                           plottitle,
                           sourcecaption,
                           ChartColours)
        
        RepaymentArrangementChart <- RepaymentArrangementChart +
          xlim(min(RepaymentArrangement$Year) - (width*0.1) , max(RepaymentArrangement$Year) + (width*0.1))
        
        RepaymentArrangementChart
        
        ggsave(
          file,
          plot =  RepaymentArrangementChart,
          width = 14,
          height = 14,
          units = "cm",
          dpi = 300
        )
        
      }
    )
    
    observeEvent(input$ToggleTable3, {
      toggle("RepaymentArrangementTable")
    })
    
    
    
    
    
    
    
    output$PriorityServicesRegisterSubtitle <- renderText({
      
      paste("Scotland,", min(PriorityServicesRegister$Year),"-",max(PriorityServicesRegister$Year))
      
    })
    
    output$PriorityServicesRegisterPlot <- renderPlotly({
      
      
      
      p <-  plot_ly(PriorityServicesRegister,x = ~ Year ) %>% 
        add_trace(data = PriorityServicesRegister,
                  x = ~ Year,
                  y = ~ ElecScotland,
                  name = "Electricity",
                  type = 'scatter',
                  mode = 'lines',
                  legendgroup = "1",
                  text = paste0(
                    "Electricity: ",
                    percent(PriorityServicesRegister$ElecScotland, .1),
                    "\nYear: ",
                    PriorityServicesRegister$Year
                  ),
                  hoverinfo = 'text',
                  line = list(width = 6, color = ChartColours[1], dash = "none")
        ) %>% 
        add_trace(
          data = tail(PriorityServicesRegister[which(PriorityServicesRegister$ElecScotland > 0 | PriorityServicesRegister$ElecScotland < 0),], 1),
          x = ~ Year,
          y = ~ ElecScotland,
          legendgroup = "1",
          name = "Electricity",
          text = paste0(
            "Electricity: ",
            percent(PriorityServicesRegister[which(PriorityServicesRegister$ElecScotland > 0 | PriorityServicesRegister$ElecScotland < 0),][-1,]$ElecScotland, .1),
            "\nYear: ",
            PriorityServicesRegister[which(PriorityServicesRegister$ElecScotland > 0 | PriorityServicesRegister$ElecScotland < 0),][-1,]$Year
          ),
          hoverinfo = 'text',
          showlegend = FALSE ,
          type = "scatter",
          mode = 'markers',
          marker = list(size = 18, 
                        color = ChartColours[1])
        ) %>% 
        add_trace(data = PriorityServicesRegister,
                  x = ~ Year,
                  y = ~ GasScotland,
                  name = "Gas",
                  type = 'scatter',
                  mode = 'lines',
                  legendgroup = "2",
                  text = paste0(
                    "Gas: ",
                    percent(PriorityServicesRegister$GasScotland, .1),
                    "\nYear: ",
                    PriorityServicesRegister$Year
                  ),
                  hoverinfo = 'text',
                  line = list(width = 6, color = ChartColours[2], dash = "none")
        ) %>% 
        add_trace(
          data = tail(PriorityServicesRegister[which(PriorityServicesRegister$GasScotland > 0 | PriorityServicesRegister$GasScotland < 0),], 1),
          x = ~ Year,
          y = ~ GasScotland,
          legendgroup = "2",
          name = "Gas",
          text = paste0(
            "Gas: ",
            percent(PriorityServicesRegister[which(PriorityServicesRegister$GasScotland > 0 | PriorityServicesRegister$GasScotland < 0),][-1,]$GasScotland, .1),
            "\nYear: ",
            PriorityServicesRegister[which(PriorityServicesRegister$GasScotland > 0 | PriorityServicesRegister$GasScotland < 0),][-1,]$Year
          ),
          hoverinfo = 'text',
          showlegend = FALSE ,
          type = "scatter",
          mode = 'markers',
          marker = list(size = 18, 
                        color = ChartColours[2])
        ) %>% 
        layout(
          barmode = 'stack',
          bargap = 0.66,
          legend = list(font = list(color = "#126992"),
                        orientation = 'h'),
          hoverlabel = list(font = list(color = "white"),
                            hovername = 'text'),
          hovername = 'text',
          
          xaxis = list(title = "",
                       showgrid = FALSE),
          yaxis = list(
            title = "",
            tickformat = "%",
            showgrid = TRUE,
            zeroline = TRUE,
            zerolinecolor = ChartColours[1],
            zerolinewidth = 2,
            rangemode = "tozero"
          )
        ) %>% 
        config(displayModeBar = F)
      p
      
    })
    
    
    output$PriorityServicesRegisterTable = renderDataTable({
      
      PriorityServicesRegisterTable <- PriorityServicesRegister
      
      names(PriorityServicesRegisterTable) <- c("Year", "Electricity - England", "Electricity", "Electricity - Wales", "Gas - England", "Gas", "Gas - Wales")
      
      datatable(
        PriorityServicesRegisterTable[c(1,3,6)],
        extensions = 'Buttons',
        
        rownames = FALSE,
        options = list(
          paging = TRUE,
          pageLength = -1,
          searching = TRUE,
          fixedColumns = FALSE,
          autoWidth = TRUE,
          ordering = TRUE,
          title = "Proportion of customers on the Priority Services Register (PSR)",
          dom = 'ltBp',
          buttons = list(
            list(extend = 'copy'),
            list(
              extend = 'excel',
              title = 'Proportion of customers on the Priority Services Register (PSR)',
              header = TRUE
            ),
            list(extend = 'csv',
                 title = 'Proportion of customers on the Priority Services Register (PSR)')
          ),
          
          # customize the length menu
          lengthMenu = list( c(10, 20, -1) # declare values
                             , c(10, 20, "All") # declare titles
          ), # end of lengthMenu customization
          pageLength = 10
        )
      ) %>%
        formatPercentage(c(2:3), 1)
    })
    
    
    output$PriorityServicesRegister.png <- downloadHandler(
      filename = "PriorityServicesRegister.png",
      content = function(file) {
        
        sourcecaption = "Source: Ofgem"
        plottitle = "Proportion of customers on the\nPriority Services Register (PSR)"
        
        width <- max(PriorityServicesRegister$Year) - min(PriorityServicesRegister$Year)
        
        #PriorityServicesRegister$ElecScotlandPercentage <- PercentLabel(PriorityServicesRegister$ElecScotland)
        
        
        PriorityServicesRegisterChart <- PriorityServicesRegister %>%
          ggplot(aes(x = Year), family = "Century Gothic") +
          
          geom_line(
            aes(
              y = ElecScotland,
              colour = ChartColours[2],
              label = percent(ElecScotland)
            ),
            size = 1.5,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year - (width*0.06),
              y = ElecScotland,
              label = ifelse(Year == min(Year), percent(ElecScotland, 0.1), ""),
              hjust = 0.5,
              colour = ChartColours[2],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year + (width*0.07),
              y = ElecScotland,
              label = ifelse(Year == max(Year), percent(ElecScotland, 0.1), ""),
              hjust = 0.5,
              vjust = 1,
              colour = ChartColours[2],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_point(
            data = tail(PriorityServicesRegister, 1),
            aes(
              x = Year,
              y = ElecScotland,
              colour = ChartColours[2],
              show_guide = FALSE
            ),
            size = 4,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = mean(Year),
              y = mean(ElecScotland),
              label = "Electricity",
              hjust = 0.5,
              vjust = -1,
              colour = ChartColours[2],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_line(
            aes(
              y = `GasScotland`,
              colour = ChartColours[3],
              label = paste0(`GasScotland` * 100, "%")
            ),
            size = 1.5,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year - (width*0.06),
              y = `GasScotland`,
              label = ifelse(Year == min(Year), percent(GasScotland, 0.1), ""),
              hjust = 0.5,
              colour = ChartColours[3],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year + (width*0.07),
              y = `GasScotland`,
              label = ifelse(Year == max(Year), percent(GasScotland, 0.1), ""),
              hjust = 0.5,
              vjust = 0,
              colour = ChartColours[3],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_point(
            data = tail(PriorityServicesRegister, 1),
            aes(
              x = Year,
              y = `GasScotland`,
              colour = ChartColours[3],
              show_guide = FALSE
            ),
            size = 4,
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = mean(Year),
              y = mean(`GasScotland`),
              label = "Gas",
              hjust = 0.5,
              vjust = 5,
              colour = ChartColours[3],
              fontface = 2
            ),
            family = "Century Gothic"
          ) +
          geom_text(
            aes(
              x = Year,
              y = 0,
              label = ifelse(Year == max(Year) |
                               Year == min(Year), Year, ""),
              hjust = 0.5,
              vjust = 1.5,
              fontface = 2
            ),
            colour = ChartColours[1],
            family = "Century Gothic"
          )
        
        
        PriorityServicesRegisterChart <-
          LinePercentChart(PriorityServicesRegisterChart,
                           PriorityServicesRegister,
                           plottitle,
                           sourcecaption,
                           ChartColours)
        
        PriorityServicesRegisterChart <- PriorityServicesRegisterChart +
          xlim(min(PriorityServicesRegister$Year) - (width*0.1) , max(PriorityServicesRegister$Year) + (width*0.1))
        
        PriorityServicesRegisterChart
        
        ggsave(
          file,
          plot =  PriorityServicesRegisterChart,
          width = 14,
          height = 14,
          units = "cm",
          dpi = 300
        )
        
      }
    )
    
    observeEvent(input$ToggleTable4, {
      toggle("PriorityServicesRegisterTable")
    })
  
  
  output$Text <- renderUI({
    tagList(column(12,
                   HTML(
                     paste(readtext("Structure/5 - Consumers/Vulnerability.txt")[2])
                     
                   )))
  })
  
  

  
  
  observeEvent(input$ToggleText, {
    toggle("Text")
  })
  
  

}
